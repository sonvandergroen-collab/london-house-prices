<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>London House Prices by MSOA</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Chroma.js for color scales -->
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>

  <style>
    :root{
      --bg:#f6f7f9;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#111827;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 16px;
    }
    html,body{height:100%; margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    body{background:var(--bg); color:var(--text);}
    .layout{
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 16px;
      padding: 16px;
      height: 100%;
      box-sizing: border-box;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .inner{padding: 16px;}
    h1{margin:0; font-size: 42px; line-height:1.05; letter-spacing:-.02em;}
    h2{margin: 0 0 8px 0; font-size:18px;}
    h3{margin: 18px 0 8px 0; font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted);}
    p{margin: 10px 0 0 0; color:var(--muted);}
    .titlebar{
      margin: 8px 0 10px 0;
      display:flex; flex-direction:column; gap: 6px;
      align-items:center;
      text-align:center;
    }
    .subtitle{max-width: 820px;}
    .highlight{
      font-size: 22px;
      font-weight: 800;
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 12px;
      background: #fff7c2;
      display:inline-block;
    }
    label{display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px;}
    select{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      background: #fff;
      outline: none;
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .stat{
      padding: 12px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
    }
    .stat .label{
      display:inline-block;
      font-size: 12px;
      color: var(--muted);
      background:#fff7c2;
      padding: 2px 6px;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .stat .value{
      font-size: 32px;
      font-weight: 800;
      letter-spacing:-.02em;
    }
    .mapwrap{height: calc(100% - 0px); display:flex; flex-direction:column;}
    #map{flex:1; min-height: 520px; border-radius: 14px; border:1px solid var(--border); overflow:hidden;}
    .legend{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 98px;
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      z-index: 600;
      width: min(520px, 72vw);
    }
    .legendTitle{font-size: 12px; color: var(--muted); margin-bottom: 6px;}
    .legendBar{height: 10px; border-radius: 999px; background: linear-gradient(90deg, #b91c1c, #f59e0b, #f3f4f6, #84cc16, #15803d);}
    .legendTicks{display:flex; justify-content:space-between; font-size: 11px; color: var(--muted); margin-top: 6px;}
    .callout{
      background:#eef2ff;
      border:1px solid #e0e7ff;
      padding: 10px 12px;
      border-radius: 12px;
      color: #1f2937;
      font-size: 13px;
    }
    .list{
      margin: 8px 0 0 0;
      padding: 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .list li{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      background:#fff7c2;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      color:#111827;
      white-space:nowrap;
    }
    .smallmuted{color:var(--muted); font-size: 12px;}
    .footer{margin-top: 10px; font-size: 12px; color: var(--muted);}
    .loading{
      display:flex; align-items:center; justify-content:center;
      height: 100%;
      color: var(--muted);
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .layout{grid-template-columns: 1fr; height:auto;}
      #map{min-height: 520px;}
      .legend{top: 140px;}
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Left controls -->
    <div class="panel">
      <div class="inner">
        <h2>Controls</h2>
        <div class="row">
          <div>
            <label for="startYear">Start Year</label>
            <select id="startYear"></select>
          </div>
          <div>
            <label for="endYear">End Year</label>
            <select id="endYear"></select>
          </div>
        </div>

        <h3>Statistics</h3>
        <div class="stat">
          <div class="label">Average Price Change</div>
          <div class="value" id="avgChange">—</div>
        </div>
        <div style="height:10px"></div>
        <div class="stat">
          <div class="label">Maximum Increase</div>
          <div class="value" id="maxInc">—</div>
        </div>
        <div style="height:10px"></div>
        <div class="stat">
          <div class="label">Maximum Decrease</div>
          <div class="value" id="maxDec">—</div>
        </div>

        <div class="footer">
          Metric: % change (End − Start) / Start.<br/>
          Data: ONS median prices (year ending Dec) + London MSOA 2021 boundaries.
        </div>
      </div>
    </div>

    <!-- Center -->
    <div class="panel">
      <div class="inner mapwrap">
        <div class="titlebar">
          <h1>London House Prices by MSOA</h1>
          <p class="subtitle">Explore how house prices have changed across different areas of London over time.</p>
          <div class="highlight" id="headline">House Price Changes</div>
        </div>
        <div style="position:relative; flex:1;">
          <div class="legend" id="legend">
            <div class="legendTitle" id="legendTitle">Price Change (%)</div>
            <div class="legendBar"></div>
            <div class="legendTicks">
              <span id="tickMin">min</span>
              <span id="tickMid">0%</span>
              <span id="tickMax">max</span>
            </div>
          </div>
          <div id="map"><div class="loading">Loading map…</div></div>
        </div>
      </div>
    </div>

    <!-- Right details -->
    <div class="panel">
      <div class="inner">
        <h2>Area Details</h2>
        <div class="callout" id="areaCallout">Click on an area in the map to see details.</div>

        <h3 style="margin-top:18px;">Top Areas by Price Increase</h3>
        <ul class="list" id="topList"></ul>

        <h3 style="margin-top:18px;">Areas with Lowest Price Changes</h3>
        <ul class="list" id="bottomList"></ul>
      </div>
    </div>
  </div>

<script>
  const fmtGBP = (n) => {
    if (n === null || n === undefined || Number.isNaN(n)) return "—";
    return new Intl.NumberFormat("en-GB", {style:"currency", currency:"GBP", maximumFractionDigits:0}).format(n);
  };
  const fmtPct = (n) => {
    if (n === null || n === undefined || Number.isNaN(n)) return "—";
    const sign = n > 0 ? "" : "";
    return `${sign}${n.toFixed(2)}%`;
  };

  let map, geoLayer;
  let geojson, prices, years;
  let currentStart, currentEnd;
  let selectedCode = null;

  // Diverging scale: red -> light -> green
  const scale = chroma.scale(["#b91c1c","#f59e0b","#f3f4f6","#84cc16","#15803d"]).mode("lab");

  function getPrice(code, year){
    const area = prices.areas[code];
    if (!area) return null;
    const v = area.prices[String(year)] ?? area.prices[year];
    return (v === undefined ? null : Number(v));
  }

  function computeChange(code, startYear, endYear){
    const p0 = getPrice(code, startYear);
    const p1 = getPrice(code, endYear);
    if (p0 === null || p1 === null || p0 === 0) return null;
    const pct = ((p1 - p0) / p0) * 100.0;
    return { pct, p0, p1 };
  }

  function styleFeature(feature){
    const code = feature.properties.msoa21cd;
    const ch = computeChange(code, currentStart, currentEnd);
    let fill = "#e5e7eb";
    let opacity = 0.85;
    if (ch && Number.isFinite(ch.pct)) {
      // clamp to legend range
      const v = Math.max(legendMin, Math.min(legendMax, ch.pct));
      fill = scale((v - legendMin) / (legendMax - legendMin)).hex();
    } else {
      opacity = 0.35;
    }
    const isSel = (selectedCode === code);
    return {
      color: isSel ? "#111827" : "#111827",
      weight: isSel ? 2.5 : 1,
      fillColor: fill,
      fillOpacity: opacity
    };
  }

  function updateLayerStyles(){
    if (!geoLayer) return;
    geoLayer.setStyle(styleFeature);
  }

  function setHeadline(){
    document.getElementById("headline").textContent = `House Price Changes (${currentStart} to ${currentEnd})`;
    document.getElementById("legendTitle").textContent = `Price Change (%) ${currentStart}–${currentEnd}`;
  }

  function populateYearSelects(){
    const startSel = document.getElementById("startYear");
    const endSel = document.getElementById("endYear");
    startSel.innerHTML = "";
    endSel.innerHTML = "";
    years.forEach(y => {
      const o1 = document.createElement("option");
      o1.value = y; o1.textContent = y;
      startSel.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = y; o2.textContent = y;
      endSel.appendChild(o2);
    });

    // sensible defaults (like screenshot)
    currentStart = years.includes(2005) ? 2005 : years[Math.max(0, years.length-10)];
    currentEnd   = years.includes(2010) ? 2010 : years[years.length-1];

    startSel.value = String(currentStart);
    endSel.value = String(currentEnd);

    startSel.addEventListener("change", () => {
      currentStart = Number(startSel.value);
      // keep start < end
      if (currentStart >= currentEnd){
        const idx = years.indexOf(currentStart);
        currentEnd = years[Math.min(years.length-1, idx+1)];
        endSel.value = String(currentEnd);
      }
      refreshAll();
    });

    endSel.addEventListener("change", () => {
      currentEnd = Number(endSel.value);
      if (currentEnd <= currentStart){
        const idx = years.indexOf(currentEnd);
        currentStart = years[Math.max(0, idx-1)];
        startSel.value = String(currentStart);
      }
      refreshAll();
    });
  }

  let legendMin = -30;
  let legendMax = 130;

  function computeLegendRange(changes){
    // robust range using percentiles
    const arr = changes.map(d=>d.pct).filter(v=>Number.isFinite(v)).sort((a,b)=>a-b);
    if (arr.length < 10) return {min:-20, max:80};
    const p = (q) => arr[Math.floor(q*(arr.length-1))];
    const lo = p(0.02);
    const hi = p(0.98);
    // make it symmetric-ish around 0 for diverging
    const maxAbs = Math.max(Math.abs(lo), Math.abs(hi));
    const min = -maxAbs;
    const max =  maxAbs;
    return {min, max};
  }

  function refreshAll(){
    setHeadline();

    // compute changes for all areas
    const changes = [];
    for (const code in prices.areas){
      const ch = computeChange(code, currentStart, currentEnd);
      if (ch) changes.push({code, pct: ch.pct, p0: ch.p0, p1: ch.p1});
    }

    // legend range
    const r = computeLegendRange(changes);
    legendMin = r.min;
    legendMax = r.max;

    document.getElementById("tickMin").textContent = `${legendMin.toFixed(0)}%`;
    document.getElementById("tickMid").textContent = `0%`;
    document.getElementById("tickMax").textContent = `${legendMax.toFixed(0)}%`;

    // stats
    const avg = changes.reduce((s,d)=>s+d.pct,0) / (changes.length || 1);
    const maxInc = changes.reduce((a,b)=> (b.pct>a.pct?b:a), changes[0] || {pct:NaN});
    const maxDec = changes.reduce((a,b)=> (b.pct<a.pct?b:a), changes[0] || {pct:NaN});

    document.getElementById("avgChange").textContent = fmtPct(avg);
    document.getElementById("maxInc").textContent = fmtPct(maxInc?.pct);
    document.getElementById("maxDec").textContent = fmtPct(maxDec?.pct);

    // lists
    const top = [...changes].sort((a,b)=>b.pct-a.pct).slice(0,5);
    const bottom = [...changes].sort((a,b)=>a.pct-b.pct).slice(0,5);

    const topList = document.getElementById("topList");
    const bottomList = document.getElementById("bottomList");
    topList.innerHTML = "";
    bottomList.innerHTML = "";

    const makeItem = (d) => {
      const li = document.createElement("li");
      const name = prices.areas[d.code]?.name || d.code;
      const left = document.createElement("div");
      left.innerHTML = `<div><strong>${name}</strong></div><div class="smallmuted">${d.code}</div>`;
      const right = document.createElement("div");
      right.innerHTML = `<div class="pill">${fmtPct(d.pct)}</div><div class="smallmuted">${fmtGBP(d.p1)}</div>`;
      li.appendChild(left);
      li.appendChild(right);
      li.style.cursor="pointer";
      li.addEventListener("click", () => zoomToCode(d.code));
      return li;
    };

    top.forEach(d => topList.appendChild(makeItem(d)));
    bottom.forEach(d => bottomList.appendChild(makeItem(d)));

    updateLayerStyles();

    // if an area is selected, refresh its callout
    if (selectedCode) showAreaDetails(selectedCode);
  }

  function showAreaDetails(code){
    const area = prices.areas[code];
    if (!area) return;
    const ch = computeChange(code, currentStart, currentEnd);
    const nm = area.name;
    const callout = document.getElementById("areaCallout");
    if (!ch){
      callout.innerHTML = `<strong>${nm}</strong><br/><span class="smallmuted">${code}</span><br/>No data for ${currentStart} or ${currentEnd}.`;
      return;
    }
    callout.innerHTML = `
      <div><strong>${nm}</strong></div>
      <div class="smallmuted">MSOA Code: ${code}</div>
      <div style="margin-top:8px">
        <div><strong>Price Change (%):</strong> ${fmtPct(ch.pct)}</div>
        <div><strong>Price in ${currentStart}:</strong> ${fmtGBP(ch.p0)}</div>
        <div><strong>Price in ${currentEnd}:</strong> ${fmtGBP(ch.p1)}</div>
        <div><strong>Change (£):</strong> ${fmtGBP(ch.p1 - ch.p0)}</div>
      </div>`;
  }

  function zoomToCode(code){
    selectedCode = code;
    // find the layer and zoom
    geoLayer.eachLayer(layer => {
      if (layer.feature?.properties?.msoa21cd === code){
        map.fitBounds(layer.getBounds(), {padding:[30,30]});
        layer.fire("click");
      }
    });
    updateLayerStyles();
  }

  async function init(){
    // Load data
    const [gj, pr] = await Promise.all([
      fetch("data/london_msoa.geojson").then(r=>r.json()),
      fetch("data/prices.json").then(r=>r.json())
    ]);
    geojson = gj;
    prices = pr;
    years = pr.years.map(Number);

    populateYearSelects();
    setHeadline();

    // map
    map = L.map("map", {zoomControl:true});
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    function onEachFeature(feature, layer){
      layer.on({
        mouseover: (e) => {
          const l = e.target;
          l.setStyle({weight:2.5});
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) l.bringToFront();
        },
        mouseout: (e) => {
          geoLayer.resetStyle(e.target);
          updateLayerStyles();
        },
        click: (e) => {
          const code = feature.properties.msoa21cd;
          selectedCode = code;
          updateLayerStyles();
          showAreaDetails(code);

          const ch = computeChange(code, currentStart, currentEnd);
          const name = prices.areas[code]?.name || feature.properties.msoa21nm || code;
          const tooltip = ch
            ? `<strong>${name}</strong><br/>${code}<br/>Price change: ${fmtPct(ch.pct)}<br/>${currentStart}: ${fmtGBP(ch.p0)}<br/>${currentEnd}: ${fmtGBP(ch.p1)}`
            : `<strong>${name}</strong><br/>${code}<br/>No data for selected years`;
          layer.bindPopup(tooltip).openPopup();
        }
      });
    }

    geoLayer = L.geoJSON(geojson, {
      style: styleFeature,
      onEachFeature
    }).addTo(map);

    map.fitBounds(geoLayer.getBounds(), {padding:[20,20]});
    refreshAll();
  }

  init().catch(err => {
    console.error(err);
    document.getElementById("map").innerHTML = `<div class="loading">Failed to load data. Check console.</div>`;
  });
</script>
</body>
</html>
